name: New Post Notification

on:
  push:
    paths:
      - 'data/blog/**/*.mdx'  # ë¸”ë¡œê·¸ ê¸€ íŒŒì¼ ë³€ê²½ ê°ì§€
    branches:
      - main

jobs:
  notify-new-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´

      - name: Check for new blog posts
        id: check_new_posts
        run: |
          # ìƒˆë¡œ ì¶”ê°€ëœ ë¸”ë¡œê·¸ íŒŒì¼ë“¤ë§Œ ì°¾ê¸° (ìˆ˜ì •/ì‚­ì œ ì œì™¸)
          NEW_FILES=$(git diff --name-only --diff-filter=A HEAD~1 HEAD | grep "^data/blog/.*\.mdx$" || true)
          
          if [ -z "$NEW_FILES" ]; then
            echo "ìƒˆë¡œ ì¶”ê°€ëœ ë¸”ë¡œê·¸ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ìƒˆ ë¸”ë¡œê·¸ ê¸€ ê°ì§€ë¨:"
          echo "$NEW_FILES"
          
          # ìƒˆ ê¸€ ì •ë³´ ìˆ˜ì§‘
          NEW_POSTS_INFO=""
          for file in $NEW_FILES; do
            echo "ë¶„ì„ ì¤‘: $file"
            
            # frontmatterì—ì„œ draft ìƒíƒœ í™•ì¸
            if grep -q "^draft: true" "$file"; then
              echo "  â†’ ì´ˆì•ˆì´ë¯€ë¡œ ìŠ¤í‚µ"
              continue
            fi
            
            # frontmatterì—ì„œ ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
            TITLE=$(grep "^title:" "$file" | sed 's/^title: *//g' | sed 's/^["'\'']\(.*\)["'\'']$/\1/')
            DATE=$(grep "^date:" "$file" | sed 's/^date: *//g')
            SUMMARY=$(grep "^summary:" "$file" | sed 's/^summary: *//g' | sed 's/^["'\'']\(.*\)["'\'']$/\1/' || echo "")
            
            # íŒŒì¼ëª…ì—ì„œ slug ì¶”ì¶œ
            SLUG=$(basename "$file" .mdx)
            
            echo "  â†’ ì œëª©: $TITLE"
            echo "  â†’ ë‚ ì§œ: $DATE"
            echo "  â†’ ìš”ì•½: $SUMMARY"
            echo "  â†’ ìŠ¬ëŸ¬ê·¸: $SLUG"
            
            # JSON í˜•íƒœë¡œ ìƒˆ ê¸€ ì •ë³´ êµ¬ì„±
            if [ -z "$NEW_POSTS_INFO" ]; then
              NEW_POSTS_INFO="[{\"title\":\"$TITLE\",\"slug\":\"$SLUG\",\"date\":\"$DATE\",\"summary\":\"$SUMMARY\"}]"
            else
              NEW_POSTS_INFO=$(echo "$NEW_POSTS_INFO" | sed 's/]$/,{"title":"'$TITLE'","slug":"'$SLUG'","date":"'$DATE'","summary":"'$SUMMARY'"}]/')
            fi
          done
          
          if [ -z "$NEW_POSTS_INFO" ]; then
            echo "ë°œí–‰ ê°€ëŠ¥í•œ ìƒˆ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤ (ëª¨ë‘ ì´ˆì•ˆ)."
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
          else
            echo "has_new_posts=true" >> $GITHUB_OUTPUT
            echo "new_posts_info<<EOF" >> $GITHUB_OUTPUT
            echo "$NEW_POSTS_INFO" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Send email notification
        if: steps.check_new_posts.outputs.has_new_posts == 'true'
        run: |
          echo "ì´ë©”ì¼ ì•Œë¦¼ ë°œì†¡ ì¤‘..."
          
          # ì´ë©”ì¼ ë°œì†¡ API í˜¸ì¶œ
          RESPONSE=$(curl -s -w "%{http_code}" -X POST "${{ secrets.DEPLOYMENT_URL || 'https://frogsoo.vercel.app' }}/api/newsletter/notify" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -d "{\"posts\": ${{ steps.check_new_posts.outputs.new_posts_info }}}" \
            -o response_body.txt)
          
          HTTP_CODE="${RESPONSE: -3}"
          RESPONSE_BODY=$(cat response_body.txt)
          
          echo "HTTP ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ì‘ë‹µ ë‚´ìš©: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… ì´ë©”ì¼ ì•Œë¦¼ì´ ì„±ê³µì ìœ¼ë¡œ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            echo "$RESPONSE_BODY"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_new_posts.outputs.has_new_posts }}" == "true" ]; then
            echo "ğŸ“§ ìƒˆ ë¸”ë¡œê·¸ ê¸€ì— ëŒ€í•œ ì´ë©”ì¼ ì•Œë¦¼ì„ ë°œì†¡í–ˆìŠµë‹ˆë‹¤."
          else
            echo "ğŸ“ ìƒˆë¡œ ì¶”ê°€ëœ ë°œí–‰ ê°€ëŠ¥í•œ ë¸”ë¡œê·¸ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤."
          fi