name: New Post Notification

on:
  push:
    paths:
      - 'data/blog/**/*.mdx'  # ë¸”ë¡œê·¸ ê¸€ íŒŒì¼ ë³€ê²½ ê°ì§€
    branches:
      - main

jobs:
  notify-new-post:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµí•˜ê¸° ìœ„í•´

      - name: Check for new blog posts
        id: check_new_posts
        run: |
          echo "ìƒˆë¡œ ì¶”ê°€ëœ ë¸”ë¡œê·¸ ê¸€ í™•ì¸ ì¤‘..."
          
          # ìµœê·¼ ì»¤ë°‹ì—ì„œ ìƒˆë¡œ ì¶”ê°€ë˜ê±°ë‚˜ ìˆ˜ì •ëœ MDX íŒŒì¼ í™•ì¸
          NEW_FILES=$(git diff --name-only --diff-filter=AM HEAD~1 HEAD | grep "^data/blog/.*\.mdx$" || true)
          
          if [ -z "$NEW_FILES" ]; then
            echo "ìƒˆë¡œ ì¶”ê°€ë˜ê±°ë‚˜ ìˆ˜ì •ëœ MDX íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ë°œê²¬ëœ íŒŒì¼ë“¤:"
          echo "$NEW_FILES"
          
          JSON_OBJECTS=""
          
          # ê° íŒŒì¼ì— ëŒ€í•´ ì²˜ë¦¬
          for file in $NEW_FILES; do
            echo "íŒŒì¼ ì²˜ë¦¬ ì¤‘: $file"
            
            if [ ! -f "$file" ]; then
              echo "íŒŒì¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤: $file"
              continue
            fi
            
            # frontmatterì—ì„œ draft ìƒíƒœ í™•ì¸
            DRAFT_STATUS=$(sed -n '/^---$/,/^---$/p' "$file" | grep "^draft:" | sed 's/draft: *//' | tr -d ' ')
            
            # draftê°€ trueì´ë©´ ìŠ¤í‚µ
            if [ "$DRAFT_STATUS" = "true" ]; then
              echo "ì´ˆì•ˆ ìƒíƒœì…ë‹ˆë‹¤. ìŠ¤í‚µ: $file"
              continue
            fi
            
            # ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
            TITLE=$(sed -n '/^---$/,/^---$/p' "$file" | grep "^title:" | sed "s/title: *//" | sed "s/['\"]//g")
            DATE=$(sed -n '/^---$/,/^---$/p' "$file" | grep "^date:" | sed "s/date: *//" | sed "s/['\"]//g")
            SUMMARY=$(sed -n '/^---$/,/^---$/p' "$file" | grep "^summary:" | sed "s/summary: *//" | sed "s/['\"]//g")
            TAGS=$(sed -n '/^---$/,/^---$/p' "$file" | grep "^tags:" | sed "s/tags: *//" | tr -d "[]'" | sed "s/,/, /g")
            
            # íŒŒì¼ëª…ì—ì„œ slug ì¶”ì¶œ
            SLUG=$(basename "$file" .mdx)
            
            echo "ì œëª©: $TITLE"
            echo "ë‚ ì§œ: $DATE"
            echo "ìš”ì•½: $SUMMARY"
            echo "íƒœê·¸: $TAGS"
            echo "ìŠ¬ëŸ¬ê·¸: $SLUG"
            
            # JSON ê°ì²´ ìƒì„±
            JSON_OBJ=$(jq -n \
              --arg title "$TITLE" \
              --arg date "$DATE" \
              --arg summary "$SUMMARY" \
              --arg tags "$TAGS" \
              --arg slug "$SLUG" \
              --arg file "$file" \
              '{
                title: $title,
                date: $date,
                summary: $summary,
                tags: $tags,
                slug: $slug,
                file: $file
              }')
            
            if [ -z "$JSON_OBJECTS" ]; then
              JSON_OBJECTS="$JSON_OBJ"
            else
              JSON_OBJECTS="$JSON_OBJECTS"$'\n'"$JSON_OBJ"
            fi
          done

          if [ -z "$JSON_OBJECTS" ]; then
            echo "ë°œí–‰ ê°€ëŠ¥í•œ ìƒˆ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤ (ëª¨ë‘ ì´ˆì•ˆ)."
            echo "has_new_posts=false" >> $GITHUB_OUTPUT
          else
            # ëª¨ë“  JSON ê°ì²´ë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ í•©ì¹˜ê³  ìµœì¢… payloadë¡œ ë˜í•‘ (ì»´íŒ©íŠ¸ ëª¨ë“œ)
            FINAL_PAYLOAD=$(echo "$JSON_OBJECTS" | jq -c -s '{"posts": .}')
            
            echo "ìƒì„±ëœ ìµœì¢… í˜ì´ë¡œë“œ:"
            echo "$FINAL_PAYLOAD"

            echo "has_new_posts=true" >> $GITHUB_OUTPUT
            echo "final_payload<<EOF" >> $GITHUB_OUTPUT
            echo "$FINAL_PAYLOAD" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Store new post info to KV
        if: steps.check_new_posts.outputs.has_new_posts == 'true'
        env:
          PAYLOAD: ${{ steps.check_new_posts.outputs.final_payload }}
        run: |
          echo "ìƒˆ ê¸€ ì •ë³´ë¥¼ KVì— ì €ì¥ ì¤‘..."
          echo "ì „ë‹¬ë°›ì€ í˜ì´ë¡œë“œ:"
          echo "$PAYLOAD"
          
          # KVì— ìƒˆ ê¸€ ì •ë³´ ì €ì¥
          RESPONSE=$(curl -s -w "%{http_code}" -X POST "${{ secrets.DEPLOYMENT_URL || 'https://frogsoo.vercel.app' }}/api/kv/store-new-post" \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer ${{ secrets.WEBHOOK_SECRET }}" \
            -d "$PAYLOAD" \
            -o response_body.txt)
          
          HTTP_CODE="${RESPONSE: -3}"
          RESPONSE_BODY=$(cat response_body.txt)
          
          echo "HTTP ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ì‘ë‹µ ë‚´ìš©: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -eq 200 ]; then
            echo "âœ… KVì— ìƒˆ ê¸€ ì •ë³´ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ KV ì €ì¥ ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            echo "$RESPONSE_BODY"
            exit 1
          fi

      - name: Trigger Vercel Build Hook
        if: steps.check_new_posts.outputs.has_new_posts == 'true'
        run: |
          echo "Vercel Build Hook íŠ¸ë¦¬ê±° ì¤‘..."
          
          # Vercel Build Hook í˜¸ì¶œ
          RESPONSE=$(curl -s -w "%{http_code}" -X POST "${{ secrets.VERCEL_BUILD_HOOK_URL }}" \
            -o hook_response.txt)
          
          HTTP_CODE="${RESPONSE: -3}"
          RESPONSE_BODY=$(cat hook_response.txt)
          
          echo "HTTP ì‘ë‹µ ì½”ë“œ: $HTTP_CODE"
          echo "ì‘ë‹µ ë‚´ìš©: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" -eq 200 ] || [ "$HTTP_CODE" -eq 201 ]; then
            echo "âœ… Vercel Build Hookì´ ì„±ê³µì ìœ¼ë¡œ íŠ¸ë¦¬ê±°ë˜ì—ˆìŠµë‹ˆë‹¤!"
          else
            echo "âŒ Build Hook íŠ¸ë¦¬ê±° ì‹¤íŒ¨ (HTTP $HTTP_CODE)"
            echo "$RESPONSE_BODY"
            exit 1
          fi

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.check_new_posts.outputs.has_new_posts }}" == "true" ]; then
            echo "ğŸ“§ ìƒˆ ë¸”ë¡œê·¸ ê¸€ ì •ë³´ë¥¼ KVì— ì €ì¥í•˜ê³  ë°°í¬ë¥¼ íŠ¸ë¦¬ê±°í–ˆìŠµë‹ˆë‹¤."
          else
            echo "ğŸ“ ìƒˆë¡œ ì¶”ê°€ëœ ë°œí–‰ ê°€ëŠ¥í•œ ë¸”ë¡œê·¸ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤."
          fi